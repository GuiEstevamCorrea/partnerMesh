name: Hotfix

on:
  push:
    branches:
      - 'hotfix/**'

jobs:
  test-and-merge:
    name: Test and Merge Hotfix
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Extract version from branch
        id: version
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          version="${branch_name#hotfix/}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Hotfix version: $version"
      
      - name: Run tests
        run: |
          echo "Testing backend..."
          cd Api
          dotnet restore
          dotnet build --configuration Release
          dotnet test --configuration Release
          
          echo "Testing frontend..."
          cd ../frontend
          npm install
          npm run build
      
      - name: Create PR to Main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: main
          title: "ðŸš¨ Hotfix v${{ steps.version.outputs.version }}"
          body: |
            ## ðŸš¨ Hotfix v${{ steps.version.outputs.version }}
            
            ### Critical Fix
            This hotfix addresses a critical issue in production.
            
            ### Checklist
            - [x] Tests passing
            - [x] Fix verified
            - [ ] Changelog updated
            
            **Auto-generated by GitHub Actions**
          labels: hotfix,urgent
      
      - name: Create PR to Develop
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: develop
          title: "ðŸš¨ Merge hotfix v${{ steps.version.outputs.version }} to develop"
          body: |
            ## Hotfix Backport
            
            Merging hotfix/${{ steps.version.outputs.version }} back to develop.
            
            **Auto-generated by GitHub Actions**
          labels: hotfix
