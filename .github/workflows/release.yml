name: Release to Production

on:
  push:
    branches:
      - 'release/**'

jobs:
  finalize-release:
    name: Finalize Release
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Extract version from branch
        id: version
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          version="${branch_name#release/}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Release version: $version"
      
      - name: Run all tests
        run: |
          echo "Running backend tests..."
          cd Api
          dotnet restore
          dotnet build --configuration Release
          dotnet test --configuration Release
          
          echo "Running frontend tests..."
          cd ../frontend
          npm ci
          npm run build
          npm test -- --passWithNoTests
      
      - name: Create Pull Request to Main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: main
          title: "Release v${{ steps.version.outputs.version }}"
          body: |
            ## Release v${{ steps.version.outputs.version }}
            
            ### Changes
            This release includes all features and fixes merged into develop since the last release.
            
            ### Checklist
            - [x] All tests passing
            - [x] Backend built successfully
            - [x] Frontend built successfully
            - [ ] Changelog updated
            - [ ] Version bumped
            
            **This PR was auto-generated by GitHub Actions**
          labels: release
      
      - name: Merge back to Develop
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout develop
          git merge --no-ff ${{ github.ref_name }} -m "chore: merge release/${{ steps.version.outputs.version }} back to develop"
          git push origin develop
