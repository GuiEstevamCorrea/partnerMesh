# 5.4. Confirmação de Alterações Críticas - Padrões de Uso

## Componente: ConfirmDialog

O componente `ConfirmDialog` é usado para solicitar confirmação do usuário antes de executar operações críticas ou destrutivas no sistema.

## Localização
```
src/components/common/ConfirmDialog/ConfirmDialog.tsx
```

## Interface

```typescript
interface ConfirmDialogProps {
  isOpen: boolean;           // Controla visibilidade do dialog
  onClose: () => void;       // Callback para cancelar/fechar
  onConfirm: () => void;     // Callback para confirmar ação
  title: string;             // Título do dialog
  message: string;           // Mensagem explicativa
  confirmText?: string;      // Texto do botão confirmar (padrão: "Confirmar")
  cancelText?: string;       // Texto do botão cancelar (padrão: "Cancelar")
  isLoading?: boolean;       // Estado de loading durante ação
  variant?: 'danger' | 'warning' | 'info'; // Variante visual (padrão: 'warning')
}
```

## Variantes

### 1. Danger (Vermelho)
Usar para operações **destrutivas** ou **irreversíveis**:
- Deletar/excluir permanentemente
- Cancelar negócios (cancela pagamentos pendentes)
- Remover dados críticos

**Exemplo:**
```tsx
<ConfirmDialog
  variant="danger"
  title="Cancelar Negócio"
  message="Esta ação cancelará o negócio e todos os pagamentos pendentes. Não é possível reverter."
/>
```

### 2. Warning (Amarelo/Cinza)
Usar para operações **com consequências** mas **reversíveis**:
- Inativar usuário/parceiro/vetor
- Alterar status de entidades
- Remover associações

**Exemplo:**
```tsx
<ConfirmDialog
  variant="warning"
  title="Inativar Usuário"
  message="O usuário não poderá fazer login até ser reativado."
/>
```

### 3. Info (Azul/Cinza)
Usar para operações **importantes** mas **sem risco**:
- Ativar usuário/parceiro
- Processar pagamentos
- Confirmações informativas

**Exemplo:**
```tsx
<ConfirmDialog
  variant="info"
  title="Ativar Usuário"
  message="O usuário poderá fazer login no sistema."
/>
```

## Padrões de Implementação

### Padrão 1: Ativar/Inativar com Mutation

**Caso de uso:** Lista de Usuários - Ativar/Inativar

```tsx
// Estado do dialog
const [confirmDialog, setConfirmDialog] = useState<{
  isOpen: boolean;
  userId: string;
  userName: string;
  action: 'activate' | 'deactivate';
}>({
  isOpen: false,
  userId: '',
  userName: '',
  action: 'activate',
});

// Mutation para toggle
const toggleActiveMutation = useMutation({
  mutationFn: usersApi.toggleActive,
  onSuccess: () => {
    showToast(
      'success',
      `Usuário ${confirmDialog.action === 'activate' ? 'ativado' : 'inativado'} com sucesso!`
    );
    setConfirmDialog({ isOpen: false, userId: '', userName: '', action: 'activate' });
    queryClient.invalidateQueries(['users']);
  },
  onError: (error: any) => {
    const message = error.response?.data?.message || 'Erro ao atualizar usuário';
    showToast('error', message);
  },
});

// Handler para abrir dialog
const handleToggleActive = (user: User) => {
  setConfirmDialog({
    isOpen: true,
    userId: user.id,
    userName: user.name,
    action: user.isActive ? 'deactivate' : 'activate',
  });
};

// Handler para confirmar
const handleConfirmToggle = () => {
  toggleActiveMutation.mutate(confirmDialog.userId);
};

// Renderização
<ConfirmDialog
  isOpen={confirmDialog.isOpen}
  title={`${confirmDialog.action === 'activate' ? 'Ativar' : 'Inativar'} Usuário`}
  message={`Tem certeza que deseja ${
    confirmDialog.action === 'activate' ? 'ativar' : 'inativar'
  } o usuário "${confirmDialog.userName}"?`}
  confirmText={confirmDialog.action === 'activate' ? 'Ativar' : 'Inativar'}
  cancelText="Cancelar"
  isLoading={toggleActiveMutation.isPending}
  onClose={() =>
    setConfirmDialog({ isOpen: false, userId: '', userName: '', action: 'activate' })
  }
  onConfirm={handleConfirmToggle}
  variant={confirmDialog.action === 'activate' ? 'info' : 'warning'}
/>
```

### Padrão 2: Validação Especial - AdminVetor Único

**Caso de uso:** Alterar perfil de usuário para AdminVetor

```tsx
// No UserFormPage, antes de salvar
const validateAdminVetorUnique = async (vectorId: string) => {
  const { data } = await usersApi.list({
    vectorId,
    permission: Permission.AdminVetor,
    isActive: true,
  });
  return data.items.length === 0;
};

// Handler de submit com validação
const onSubmit = async (data: UserFormData) => {
  // Se está alterando para AdminVetor
  if (data.permission === Permission.AdminVetor && data.vectorId) {
    // Verificar se já existe AdminVetor ativo no vetor
    const isUnique = await validateAdminVetorUnique(data.vectorId);
    
    if (!isUnique && isEditMode) {
      // Abrir confirm dialog para confirmar troca
      setConfirmDialog({
        isOpen: true,
        title: 'AdminVetor já existe',
        message: 'Este vetor já possui um AdminVetor ativo. Deseja continuar e tornar este usuário o novo AdminVetor?',
        variant: 'warning',
        onConfirm: () => saveUser(data),
      });
      return;
    }
  }
  
  // Salvar normalmente
  saveUser(data);
};
```

### Padrão 3: Resetar Senha

**Caso de uso:** Resetar senha de usuário (gera senha temporária)

```tsx
// API
const resetPassword = (userId: string) => {
  return api.post(`/users/${userId}/reset-password`);
};

// Estado
const [resetPasswordDialog, setResetPasswordDialog] = useState({
  isOpen: false,
  userId: '',
  userName: '',
});

// Mutation
const resetPasswordMutation = useMutation({
  mutationFn: resetPassword,
  onSuccess: (response) => {
    showToast('success', `Senha resetada! Nova senha: ${response.data.tempPassword}`);
    setResetPasswordDialog({ isOpen: false, userId: '', userName: '' });
  },
  onError: () => {
    showToast('error', 'Erro ao resetar senha');
  },
});

// ConfirmDialog
<ConfirmDialog
  isOpen={resetPasswordDialog.isOpen}
  title="Resetar Senha"
  message={`Uma senha temporária será gerada para "${resetPasswordDialog.userName}". O usuário deverá alterá-la no próximo login.`}
  confirmText="Resetar Senha"
  isLoading={resetPasswordMutation.isPending}
  onClose={() => setResetPasswordDialog({ isOpen: false, userId: '', userName: '' })}
  onConfirm={() => resetPasswordMutation.mutate(resetPasswordDialog.userId)}
  variant="warning"
/>
```

### Padrão 4: Cancelar Negócio

**Caso de uso:** Cancelar negócio (ação destrutiva)

```tsx
<ConfirmDialog
  isOpen={cancelDialog.isOpen}
  title="Cancelar Negócio"
  message="Ao cancelar o negócio, todos os pagamentos pendentes serão cancelados. Pagamentos já realizados não serão afetados. Esta ação não pode ser revertida."
  confirmText="Cancelar Negócio"
  variant="danger"
  isLoading={cancelMutation.isPending}
  onClose={() => setCancelDialog({ isOpen: false, businessId: '' })}
  onConfirm={handleCancelBusiness}
/>
```

### Padrão 5: Pagamento em Lote

**Caso de uso:** Processar múltiplos pagamentos

```tsx
<ConfirmDialog
  isOpen={paymentDialog.isOpen}
  title="Confirmar Pagamento em Lote"
  message={
    <>
      <p className="mb-2">Confirmar processamento de {selectedPayments.length} pagamento(s):</p>
      <ul className="list-disc list-inside mb-2">
        <li>Total: {formatCurrency(totalAmount)}</li>
        <li>Destinatários: {uniqueRecipients.length}</li>
      </ul>
      <p className="text-sm text-gray-600">Esta ação não poderá ser revertida.</p>
    </>
  }
  confirmText="Confirmar Pagamentos"
  variant="info"
  isLoading={processPaymentsMutation.isPending}
  onClose={() => setPaymentDialog({ isOpen: false })}
  onConfirm={handleProcessPayments}
/>
```

## Checklist de Implementação

Ao implementar ConfirmDialog para uma operação crítica:

- [ ] **Estado do Dialog:** Criar estado com `useState` contendo dados necessários
- [ ] **Mutation/Action:** Implementar a ação que será executada
- [ ] **Handler de Abertura:** Função que abre o dialog com os dados corretos
- [ ] **Handler de Confirmação:** Função que executa a mutation/action
- [ ] **Handler de Fechamento:** Função que limpa o estado e fecha
- [ ] **Loading State:** Passar `isLoading` da mutation para o dialog
- [ ] **Variante Correta:** Escolher `danger`, `warning` ou `info`
- [ ] **Mensagem Clara:** Explicar consequências da ação
- [ ] **Toast de Feedback:** Exibir resultado (sucesso/erro)
- [ ] **Invalidação de Cache:** Atualizar queries do React Query se necessário

## Operações que DEVEM usar ConfirmDialog

### Críticas (OBRIGATÓRIO)
1. ✅ **Inativar usuário** (UsersListPage)
2. ⏳ **Alterar perfil para AdminVetor** (UserFormPage)
3. ⏳ **Resetar senha de usuário** (UsersListPage ou UserDetailPage)
4. ⏳ **Inativar vetor** (VectorsListPage)
5. ⏳ **Inativar parceiro** (PartnersListPage)
6. ⏳ **Cancelar negócio** (BusinessDetailPage)
7. ⏳ **Processar pagamentos em lote** (PaymentsListPage)
8. ⏳ **Inativar tipo de negócio** (BusinessTypesListPage)

### Recomendadas
- Deletar filtros salvos
- Limpar dados em massa
- Exportar dados sensíveis
- Alterar configurações críticas

## Boas Práticas

### ✅ Fazer
- Usar mensagens claras e objetivas
- Explicar consequências da ação
- Usar variante apropriada ao risco
- Passar estado de loading
- Invalidar queries após sucesso
- Exibir toast de feedback
- Desabilitar botões durante loading

### ❌ Evitar
- Mensagens genéricas ("Tem certeza?")
- Múltiplos dialogs aninhados
- Confirmação para ações triviais
- Textos técnicos ou códigos de erro
- Variante `danger` para tudo
- Esquecer loading state

## Testes Manuais

Para cada implementação de ConfirmDialog:

1. ✅ Dialog abre com dados corretos
2. ✅ Botão "Cancelar" fecha sem executar ação
3. ✅ Botão "Confirmar" executa ação
4. ✅ Loading state exibido durante processamento
5. ✅ Botões desabilitados durante loading
6. ✅ Dialog fecha automaticamente após sucesso
7. ✅ Toast de feedback exibido
8. ✅ Dados atualizados na interface
9. ✅ Erro exibido adequadamente se falhar
10. ✅ Dialog pode ser fechado após erro

## Melhorias Futuras (Pós-MVP)

- [ ] Adicionar campo de textarea para justificativa
- [ ] Histórico de confirmações no log de auditoria
- [ ] Tempo de espera forçado para ações destrutivas (3 segundos)
- [ ] Confirmação dupla para ações muito críticas (digitar nome)
- [ ] Atalhos de teclado (Enter = confirmar, Esc = cancelar)
- [ ] Animações de entrada/saída suaves
- [ ] Sons de feedback (opcional, configurável)

---

**Status:** ✅ Implementado e Documentado  
**Última Atualização:** 16/12/2025  
**Responsável:** GitHub Copilot
